<!-- title: Public Record -->
DD01 Public Record Specification // DRAFT
================================

Overview
--------
The single shared history created by what we call a "public record" is a central and novel concept to Ombuds.
In the same way that a block chain can define a "public ledger" that records all account balances of digital units of currency, a block chain can define a "public record" that digitally records all public statements submitted to it.
This document defines the behavior of the public record and discusses the pratical implications of using the Bitcoin block chain as a public ledger.


Status of This Document
-----------------------
While this is not an RFC, the intention behind this document is to describe the system completely so that it is reproducible and well understood.
Please understand this is a **draft of a design** that is subject to change. 
Do not rely the content of this document for critical decisions.
It has not been reviewed.

Alex, Nick -- Nov 2, 2015


Contents
--------

1. Definition
2. Behavior
    1. Eventual Consistency
    2. Long Reorginizations
3. Discussion
    1. Unique State
    2. Censoring Records  


Definition
----------
The public record is comprised of all *records* ([bulletins](/bulletin) and [endorsements](/endorsement)) [encoded](/record-encoding-formats) within bitcoin transactions that have four or more confirmations.  

   
Behavior
--------
### Eventual Consistency

To ensure that nodes agree to the state of the public record, only records that have more than **four** confirmations are marked as committed to the record.
This means that bulletins that are generated by a user and not mined are left out of the public record.
This also means that every full node that is constructing the record from the Bitcoin block chain that is consistent to **four** blocks deep has the exact same public record.

Nodes in the network can still inform clients of unconfirmed and recently mined records. 
A node just cannot claim that a specific record is in the official public record, if it is not **four** blocks deep in the best chain.
By enforcing this constrait on the public record, we are able to assert that any full node is reconstructing a well-defined, globally consistent history of immutable messages that takes the equivalent of **four** blocks of work to undo.

### Choice of Parameters

After a record is four blocks deep we call it "confirmed."
Records that are in the best chain, but not four blocks deep are called "pending" or "pending confirmation."
The reason that the record is generated from records **four** blocks deep is so that, a user is not told that their message is confirmed or "in the chain" until a significant amount of work has been invested in those messages.

There is a tradeoff between speed of confirmation and security that comes from waiting for more blocks in the chain before considering a bitcoin transaction "confirmed".
For our purposes we have planted our flag in the ground at **four** blocks and acknowledge the dangers in doing so. 

Be aware that this is a tunable parameter and it is **subject to change.**

### Longer Reorganizations

Records dropped as a result of a large chain reorginzation, like the one that occured in [March 2013](https://github.com/bitcoin/bips/blob/master/bip-0050.mediawiki) will be rebroadcast on a best effort basis.
This represents the one real challenge to the eventual consistence.
The other is an unknown exploit that changes either the public record or the bitcoin block chain.


Discussion
----------
### Unique State
By enforcing the depth requirement all nodes -- even if they possess different chain tips -- will have the same public record.
In the example, Node 1 and 2 have different best chain tips, but they still agree on the prA, which is the public record derived **four** blocks deep.


    Node 1
    <-- A <-- B <-- D <-- E
        |
       prA

    Node 2
    <-- A <-- B <-- X <-- Y
        |  
       prA 

Forcing users to wait before they are told their record is commit to the public record is not ideal, but it is better than misinforming them their record was succesfully secured within the public record.

### Censored Records
Records can be excluded or censored from the public record in a variety of ways and for a variety of reasons.
It is important to understand that records that a user cannot get to the honest Bitcoin network will never be mined.
The sections that follow assume that at the very least a user was able to reach a peer in the honest Bitcoin network.

#### Non-relayed Transaction

Bitcoin transactions that do not pay enough fees or are considered non-standard will not be relayed by Bitcoin network peers.
For records submitted to peers to be mined, the containing transaction must conform to the networks rules.
The common, if insecure technique, to determine if a transaction has been relayed into the network is to submit the transaction to one peer and see if another peer informs the client of its arrival at their node.

The only way to know for sure if the transaction has been relayed around the network is to see proof that it is committed into the best chain and stored in the public record.

#### Excluded Records

Records or bulletins that are relayed around the network, but are never mined are stored permanently by Ombuds nodes in their floating database. 
These records will randomly rebroadcast to the bitcoin network by nodes to see if they will be mined. 

#### Orphaned Records

Records or bulletins that are mined in blocks that are orphaned or not in the 'best' chain will be placed in the floating database.
Like excluded records these messages will be rebroadcast on the network.

#### Black Listed Records

Ombrelays or bitcoin nodes might refuse to serve records stored in the public record that they view as invalid, immoral, or illegal.
These records can be obtained from a copy of the full block chain and can be filled in from any node that has the blocks in which these records reside.

Versions
--------
In general the Ombuds protocol will support backwards compatability with older formats of the record.
Unless significant changes are required to prevent exploits newer versions of the protocol will preserve and relay older records.
Later version will support and relay old records, but they might transform the structure of older messages.


-----------
Database Structure
------------------
The records stored are divided between two crucial components:

    // floating.db
    -------------
    | Floating  |     <--- Contains unconfirmed, orphaned, and new records.
    -------------

    // pubrec.db
    -------------
    |  Pending  |     <--- Contains all records in the best valid chain.
    |  Commit   |
    -------------

### Redundancy and Availability Requirements

Nodes that serve the public record will also serve the block chain.
While it is possible to prune non-relevant application data from an Ombuds node, it is important to the overall health of the Bitcoin network that Ombuds nodes support it.

### Derivation 

The block chain must remain available and effecient to rederive the public record.
A new node that joins the network can resimulate the blockchain and arrive at the same state as its peers.
